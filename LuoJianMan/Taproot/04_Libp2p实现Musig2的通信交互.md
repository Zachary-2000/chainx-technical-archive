# Libp2p实现Musig2的通信交互

## 纲要

1. [Musig2方案](#Musig2方案)
2. [Libp2p](#Libp2p)
   1. [节点身份](#节点身份)
   2. [连接处理](#连接处理)
   3. [传输层](#传输层)
   4. [网络行为](#网络行为)
   5. [发布、订阅机制](#发布、订阅机制)
3. [为什么选择Libp2p](#为什么选择Libp2p)
4. [总结](#总结)

## Musig2方案

MuSig具有创新的密钥聚合特性，Musig方案下的签名是一种常规的`Schnorr`签名，一旦Taproot被激活，比特币网络就可以对这种签名进行处理。当用于创建多重签名钱包时，与使用CHECKMULTISIG操作码进行n-of-n多重签名的传统方式相比，MuSig降低了交易费用并增加了隐私性，而传统方法则在区块链上需要n个公钥以及n个ECDSA签名。但由于签名者之间需要多轮通信，在实践中部署MuSig可能很困难，更准确地说，Musig1方案下创建签名需要三轮通信，而每一轮通信都由来回传递的消息组成。为了改进MuSig，使得签名过程变得更加容易，可以使用BlockStream设计的新方案MuSig2。在 MuSig2 的方案中，从原来的三轮交互（MuSig）优化为只需要两轮的交互，且提供了与MuSig相同的功能和安全性，只增加了少量的额外计算，是聚合签名的绝佳方案。

![Musig2](https://cdn.jsdelivr.net/gh/rjman-ljm/resources@master/assets/1628049333541-musig2-overview.png)

Musig2交易在比特币主网络上会和普通交易相仿，难以区分，因此在链上的操作和发送普通交易是类似的，那么聚合签名的过程就需要在链下进行完成。因此，ChainX的Taproot BTC跨链升级方案为实现Musig2的链下聚合签名，可以考虑采用`libp2p`实现去中心化的聚合签名。

## libp2p

Libp2p是一个由协议, 规范和代码库组成的模块化系统,能够进行p2p网络的开发，解决p2p网络下节点发现和节点间数据流转的问题。

1. 高效的`节点发现`：能够发现P2P网络中的其它节点及维护节点在线状态，并且根据节点状态调整网络连接，构建稳定的网络拓扑。
2. 安全的`数据传输`：数据传输负责节点间数据的流转。为了支持各种异构的网络设备互连，libp2p核心要求之一就是传输层不可知，libp2p支持不同的传输层协议，例如TCP、UDP、QUIC等。在传输层建立连接后还需要考虑网络数据的隐私安全，libp2p对传输通道加密，节点间通过加密通道进行通信。为了高效传输数据，libp2p支持对连接进行多路流复用从而支持节点间多个并发流通信。

### 节点身份

在libp2p中每个节点的身份是一个密钥对，每一个节点的身份通过`PeerID`标识，PeerID是一串字符，由节点公钥的hash产生，并进行base58编码。有了节点ID，将允许任何人通过检索公钥进行节点身份认证，这使得节点之间能够安全的通信，有效解决中间人攻击问题。

由于每种传输协议都有自己的地址格式，libp2p使用`multiaddr`的编码方案来统一不同的协议的地址格式。

例如`/ip4/192.168.1.11/tcp/9999/p2p/12D3KooWGHPFrxdTaDiu5LTFRvnvk5jMQfzTsmop4A5qaiNhsbMH`，能够了解到IP地址为192.168.1.11，采用TCP协议，使用的端口是9999，是一个P2P节点，节点ID为12D3KooWGHPFrxdTaDiu5LTFRvnvk5jMQfzTsmop4A5qaiNhsbMH。

### 连接处理

libp2p的`Swarm`模块负责将多个传输层（如TCP、UDP）组合到一个接口中，从而允许应用程序连接远程节点时，不必指定要使用的传输层。Swarm主要负责管理节点之间连接的创建、维护、销毁。包括协议多路复用、流多路复用、NAT穿透和连接中继，同时进行多路传输。Network接口是libp2p对外提供服务的接口，Swarm是Network接口的具体实现，libp2p在Swarm中维护现有连接的状态，维护支持的传输层协议。Swarm通过以下操作支持多传输协议：

	1. 新建节点（NewNode）时会将节点支持的传输层协议通过AddTransport加入Swarm的transports结构中。
	2. 当节点打开监听(Listen)时，Swarm模块会调用TransportForListening获取监听地址对应的传输层协议，并调用相应的传输层协议的Listen函数。
	3. 当节点主动拨号(Dial)其它节点时，Swarm模块会调用TransportForDialing获取拨号地址使用的传输协议，并调用相应的传输层协议的Dial函数。

### 传输层

`Transport`定义数据传输的方式（协议）并保证数据传输过程中的隐私性。TcpTransport是TCP的传输层实现模块，其中组合了Upgrader模块，Upgrader负责把一个原始的TCP连接升级为支持加密，支持多路流复用的连接。secio和tls是两个实现了SecureTransport接口的库，Libp2p库默认使用secio加密库。

libp2p应用程序通常会在节点之间打开许多独立的通信流，并且可能会与某个远程节点同时打开多个并发流。多路流复用允许与远程节点建立一次连接即可完成整个生命周期的数据收发，同样只需要处理一次NAT操作，因为和同一个远程节点所有的流都共享相同的底层传输连接。在配置Libp2p时，会启用流复用模块，Swarm将在拨号远程节点和侦听连接时使用它们。如果远程节点支持相同的多路流复用实现，则Swarm将在建立连接时选择并使用它；如果拨号Swarm已经与之建立连接的远程节点，则新建流将自动在现有连接上进行多路复用。

### 网络行为

`Transport`定义了在网络上发送字节的方式，而`NetworkBehaviour`定义了要在网络上发送哪些字节。更具体一点地说，类似于网络工具ping，本地节点将ping发送到远程节点，并希望据此接收到pong。Ping NetworkBehaviour不在乎ping或pong消息如何在网络上发送，无论它们是通过TCP、noise加密或是纯文本形式，它只关心在网络上发送什么内容。

### 发布、订阅机制

发送消息到其他节点是P2P系统的核心，发布和订阅是一种向特定节点发送他们所感兴趣的消息的一种非常有用的机制。libp2p定义了publish与subscribe接口，用于向所有订阅了特定主题的节点发送相应的消息。当前稳定的接口实现有两种：floodsub使用起来非常简单，但是效率不高，它使用的是network flooding策略；gossipsub定义了一个可扩展的gossip协议。episub目前也正在积极的开发中，它是对gossipsub进行了扩展，这是为単源组播和少数固定源向大量客户端广播进行优化的。

![pub/sub](https://cdn.jsdelivr.net/gh/rjman-ljm/resources@master/assets/1628065139421-1628065139418.png)

## 为什么选择Libp2p

libp2p通过`multiaddr`的编码方案来统一不同协议的地址格式，在Swarm模块根据`multiaddr`解析协议并调用相应协议的接口完成具体操作，从而达到了应用层不需要关注使用的传输层协议的目的，并提供了简单的接口用于适应现存的或未来的协议，这使得libp2p应用程序可以运行在许多不同的网络环境中。

## 总结

Musig2方案的链下实现，采用libp2p能够很好地达到去中心化的目的，可以预见，在BTC网络激活Taproot后，参与Musig2方案进行链下聚合签名并结合链上Schnorr签名带来的隐私性，能够最大程度上保护用户在交易过程中的隐私和安全。

